{% extends "base.html" %}

{% block title %}Agri-FinTech | Kerala Smart Farmer{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="text-center mb-4">
        <h1 class="display-5 fw-bold text-success">
            <i class="fas fa-rupee-sign me-2"></i>Agri-FinTech Hub
        </h1>
        <p class="lead text-muted">Smart Farming Finance Tools for Kerala Farmers</p>
        <div class="badge bg-success fs-6 px-3 py-2">
            <i class="fas fa-map-marker-alt me-1"></i> Exclusively for Kerala State
        </div>
    </div>

    <!-- Service Cards -->
    <div class="row g-4 mb-5">
        <div class="col-lg-4">
            <div class="card h-100 border-0 shadow-sm hover-card" onclick="showSection('loan')">
                <div class="card-body text-center p-4">
                    <div class="icon-circle bg-primary bg-opacity-10 mx-auto mb-3">
                        <i class="fas fa-hand-holding-usd fa-2x text-primary"></i>
                    </div>
                    <h5 class="card-title fw-bold">Loan Eligibility Checker</h5>
                    <p class="card-text text-muted">Check your eligibility for Kerala agricultural loans including KCC, KSCARDB, and Kerala Bank schemes.</p>
                    <button class="btn btn-outline-primary">Check Eligibility <i class="fas fa-arrow-right ms-1"></i></button>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100 border-0 shadow-sm hover-card" onclick="showSection('insurance')">
                <div class="card-body text-center p-4">
                    <div class="icon-circle bg-warning bg-opacity-10 mx-auto mb-3">
                        <i class="fas fa-shield-alt fa-2x text-warning"></i>
                    </div>
                    <h5 class="card-title fw-bold">Crop Insurance Analysis</h5>
                    <p class="card-text text-muted">Analyze risk and get insurance recommendations under PMFBY and Kerala State schemes.</p>
                    <button class="btn btn-outline-warning">Analyze Risk <i class="fas fa-arrow-right ms-1"></i></button>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100 border-0 shadow-sm hover-card" onclick="showSection('subsidy')">
                <div class="card-body text-center p-4">
                    <div class="icon-circle bg-success bg-opacity-10 mx-auto mb-3">
                        <i class="fas fa-gift fa-2x text-success"></i>
                    </div>
                    <h5 class="card-title fw-bold">Subsidy Recommendations</h5>
                    <p class="card-text text-muted">Discover government subsidies you're eligible for - PM-KISAN, PMKSY, SMAM, and more.</p>
                    <button class="btn btn-outline-success">Find Subsidies <i class="fas fa-arrow-right ms-1"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loan Eligibility Section -->
    <div id="loan-section" class="service-section" style="display: none;">
        <div class="card border-0 shadow">
            <div class="card-header bg-primary text-white py-3">
                <h4 class="mb-0"><i class="fas fa-hand-holding-usd me-2"></i>Loan Eligibility Checker</h4>
            </div>
            <div class="card-body p-4">
                <form id="loan-form">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">District</label>
                            <select name="district" class="form-select" required>
                                <option value="">Select District</option>
                                {% for district in districts %}
                                <option value="{{ district }}">{{ district }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Crop</label>
                            <select name="crop" class="form-select" required>
                                <option value="">Select Crop</option>
                                <option value="Paddy">Paddy (Rice)</option>
                                <option value="Banana">Banana</option>
                                <option value="Coconut">Coconut</option>
                                <option value="Pepper">Pepper</option>
                                <option value="Rubber">Rubber</option>
                                <option value="Vegetables">Vegetables</option>
                                <option value="Tapioca">Tapioca</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Land Size (Acres)</label>
                            <input type="number" name="land_size" class="form-control" step="0.1" min="0.1" placeholder="e.g., 2.5" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Annual Income (₹)</label>
                            <input type="number" name="annual_income" class="form-control" min="10000" placeholder="e.g., 150000" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Loan Amount Needed (₹)</label>
                            <input type="number" name="loan_amount" class="form-control" min="10000" placeholder="e.g., 100000" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Existing Loans (₹)</label>
                            <input type="number" name="existing_loans" class="form-control" value="0" min="0" placeholder="Enter 0 if no existing loans">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Do you have collateral (land/gold)?</label>
                            <select name="has_collateral" class="form-select">
                                <option value="yes">Yes, I have collateral</option>
                                <option value="no">No collateral available</option>
                            </select>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg px-5">
                            <i class="fas fa-search me-2"></i>Check Loan Eligibility
                        </button>
                    </div>
                </form>
                <div id="loan-results" class="mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Crop Insurance Section -->
    <div id="insurance-section" class="service-section" style="display: none;">
        <div class="card border-0 shadow">
            <div class="card-header bg-warning text-dark py-3">
                <h4 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Crop Insurance Risk Analysis</h4>
            </div>
            <div class="card-body p-4">
                <form id="insurance-form">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">District</label>
                            <select name="district" class="form-select" required>
                                <option value="">Select District</option>
                                {% for district in districts %}
                                <option value="{{ district }}">{{ district }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Crop</label>
                            <select name="crop" class="form-select" required>
                                <option value="">Select Crop</option>
                                <option value="Paddy">Paddy (Rice)</option>
                                <option value="Banana">Banana</option>
                                <option value="Coconut">Coconut</option>
                                <option value="Pepper">Pepper</option>
                                <option value="Rubber">Rubber</option>
                                <option value="Vegetables">Vegetables</option>
                                <option value="Tapioca">Tapioca</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Land Size (Acres)</label>
                            <input type="number" name="land_size" class="form-control" step="0.1" min="0.1" placeholder="e.g., 2.5" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Season</label>
                            <select name="season" class="form-select" required>
                                <option value="">Select Season</option>
                                <option value="Kharif">Kharif (Monsoon: June-October)</option>
                                <option value="Rabi">Rabi (Winter: November-March)</option>
                                <option value="Summer">Summer (March-June)</option>
                            </select>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-warning btn-lg px-5">
                            <i class="fas fa-chart-line me-2"></i>Analyze Insurance Risk
                        </button>
                    </div>
                </form>
                <div id="insurance-results" class="mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Subsidy Section -->
    <div id="subsidy-section" class="service-section" style="display: none;">
        <div class="card border-0 shadow">
            <div class="card-header bg-success text-white py-3">
                <h4 class="mb-0"><i class="fas fa-gift me-2"></i>Subsidy Recommendations</h4>
            </div>
            <div class="card-body p-4">
                <form id="subsidy-form">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">District</label>
                            <select name="district" class="form-select" required>
                                <option value="">Select District</option>
                                {% for district in districts %}
                                <option value="{{ district }}">{{ district }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Primary Crop</label>
                            <select name="crop" class="form-select" required>
                                <option value="">Select Crop</option>
                                <option value="Paddy">Paddy (Rice)</option>
                                <option value="Banana">Banana</option>
                                <option value="Coconut">Coconut</option>
                                <option value="Pepper">Pepper</option>
                                <option value="Rubber">Rubber</option>
                                <option value="Vegetables">Vegetables</option>
                                <option value="Tapioca">Tapioca</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Land Size (Acres)</label>
                            <input type="number" name="land_size" class="form-control" step="0.1" min="0.1" placeholder="e.g., 2.5" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Farmer Category</label>
                            <select name="category" class="form-select" required>
                                <option value="general">General</option>
                                <option value="sc">SC (Scheduled Caste)</option>
                                <option value="st">ST (Scheduled Tribe)</option>
                                <option value="woman">Woman Farmer</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Do you have irrigation?</label>
                            <select name="has_irrigation" class="form-select">
                                <option value="yes">Yes</option>
                                <option value="no">No (Rain-fed farming)</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="organic_interest" id="organic_interest">
                                <label class="form-check-label" for="organic_interest">
                                    I am interested in organic farming
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-success btn-lg px-5">
                            <i class="fas fa-search-dollar me-2"></i>Find My Subsidies
                        </button>
                    </div>
                </form>
                <div id="subsidy-results" class="mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Quick Facts -->
    <div class="row g-4 mt-5">
        <div class="col-12">
            <h4 class="fw-bold mb-3"><i class="fas fa-info-circle text-primary me-2"></i>Kerala Agricultural Finance - Quick Facts</h4>
        </div>
        <div class="col-md-3">
            <div class="card bg-light border-0 h-100">
                <div class="card-body text-center">
                    <h2 class="text-primary fw-bold">4%</h2>
                    <p class="mb-0">Effective interest rate on KCC loans (after subvention)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light border-0 h-100">
                <div class="card-body text-center">
                    <h2 class="text-success fw-bold">₹6,000</h2>
                    <p class="mb-0">Annual PM-KISAN benefit for small farmers</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light border-0 h-100">
                <div class="card-body text-center">
                    <h2 class="text-warning fw-bold">60%</h2>
                    <p class="mb-0">Subsidy on solar pumps under PM-KUSUM</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light border-0 h-100">
                <div class="card-body text-center">
                    <h2 class="text-danger fw-bold">2%</h2>
                    <p class="mb-0">Farmer's premium share under PMFBY</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .icon-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .hover-card {
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .hover-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
    }
    .loan-card {
        border-left: 4px solid;
        transition: all 0.3s ease;
    }
    .loan-card.eligible {
        border-left-color: #28a745;
    }
    .loan-card.not-eligible {
        border-left-color: #dc3545;
        opacity: 0.8;
    }
    .risk-badge {
        font-size: 0.9rem;
        padding: 8px 16px;
    }
    .risk-high { background-color: #dc3545; color: white; }
    .risk-medium { background-color: #ffc107; color: black; }
    .risk-low { background-color: #28a745; color: white; }
</style>

<script>
function showSection(section) {
    // Hide all sections
    document.querySelectorAll('.service-section').forEach(el => el.style.display = 'none');
    // Show selected section
    document.getElementById(section + '-section').style.display = 'block';
    // Scroll to section
    document.getElementById(section + '-section').scrollIntoView({ behavior: 'smooth' });
}

// Loan Form Handler
document.getElementById('loan-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const resultsDiv = document.getElementById('loan-results');
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Checking eligibility...</p></div>';
    
    try {
        const response = await fetch('/fintech/check-loan', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        if (data.error) {
            resultsDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else {
            displayLoanResults(data);
        }
    } catch (error) {
        resultsDiv.innerHTML = '<div class="alert alert-danger">Error checking eligibility. Please try again.</div>';
    }
});

// Insurance Form Handler
document.getElementById('insurance-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const resultsDiv = document.getElementById('insurance-results');
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-warning" role="status"></div><p class="mt-2">Analyzing risk...</p></div>';
    
    try {
        const response = await fetch('/fintech/analyze-insurance', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        if (data.error) {
            resultsDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else {
            displayInsuranceResults(data);
        }
    } catch (error) {
        resultsDiv.innerHTML = '<div class="alert alert-danger">Error analyzing insurance. Please try again.</div>';
    }
});

// Subsidy Form Handler
document.getElementById('subsidy-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const resultsDiv = document.getElementById('subsidy-results');
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-success" role="status"></div><p class="mt-2">Finding subsidies...</p></div>';
    
    try {
        const response = await fetch('/fintech/get-subsidies', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        if (data.error) {
            resultsDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else {
            displaySubsidyResults(data);
        }
    } catch (error) {
        resultsDiv.innerHTML = '<div class="alert alert-danger">Error finding subsidies. Please try again.</div>';
    }
});

function displayLoanResults(data) {
    const resultsDiv = document.getElementById('loan-results');
    let html = '<h5 class="fw-bold mb-3"><i class="fas fa-list me-2"></i>Loan Options for You</h5>';
    
    data.loans.forEach((loan, index) => {
        const eligibleClass = loan.eligible ? 'eligible' : 'not-eligible';
        const badgeClass = loan.eligible ? 'bg-success' : 'bg-danger';
        const badgeText = loan.eligible ? 'ELIGIBLE' : 'NOT ELIGIBLE';
        
        html += `
            <div class="card loan-card ${eligibleClass} mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title mb-0">${loan.loan_name}</h5>
                        <span class="badge ${badgeClass}">${badgeText}</span>
                    </div>
                    <p class="text-muted mb-2"><i class="fas fa-building me-1"></i> ${loan.provider}</p>
                    ${loan.eligible ? `
                        <div class="row g-2 mb-3">
                            <div class="col-md-3">
                                <div class="bg-light rounded p-2 text-center">
                                    <small class="text-muted d-block">Max Amount</small>
                                    <strong class="text-primary">₹${loan.max_eligible_amount.toLocaleString()}</strong>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="bg-light rounded p-2 text-center">
                                    <small class="text-muted d-block">Interest Rate</small>
                                    <strong class="text-success">${loan.interest_rate}% p.a.</strong>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="bg-light rounded p-2 text-center">
                                    <small class="text-muted d-block">Monthly EMI</small>
                                    <strong>₹${loan.monthly_emi.toLocaleString()}</strong>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="bg-light rounded p-2 text-center">
                                    <small class="text-muted d-block">Tenure</small>
                                    <strong>${loan.tenure_months} months</strong>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    <p class="mb-2"><i class="fas fa-info-circle text-info me-1"></i> ${loan.reason}</p>
                    <details class="mt-2">
                        <summary class="text-primary" style="cursor: pointer;">View Documents Required</summary>
                        <ul class="mt-2 mb-0">
                            ${loan.documents_required.map(doc => `<li>${doc}</li>`).join('')}
                        </ul>
                        <p class="mt-2 mb-0"><strong>Apply at:</strong> ${loan.apply_at}</p>
                    </details>
                </div>
            </div>
        `;
    });
    
    resultsDiv.innerHTML = html;
}

function displayInsuranceResults(data) {
    const resultsDiv = document.getElementById('insurance-results');
    
    // Check if data has required fields
    if (!data.overall_risk || !data.recommendations) {
        resultsDiv.innerHTML = '<div class="alert alert-danger">Invalid response from server. Please try again.</div>';
        return;
    }
    
    let html = '';
    
    // Risk Assessment Header
    const riskClass = data.overall_risk.includes('HIGH') ? 'risk-high' : (data.overall_risk.includes('MEDIUM') ? 'risk-medium' : 'risk-low');
    html += `
        <div class="alert alert-${data.overall_risk.includes('HIGH') ? 'danger' : (data.overall_risk.includes('MEDIUM') ? 'warning' : 'success')} mb-4">
            <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Risk Assessment</h5>
            <span class="badge ${riskClass} risk-badge">${data.overall_risk}</span>
            <p class="mb-0 mt-2">${data.risk_factors}</p>
        </div>
    `;
    
    html += '<h5 class="fw-bold mb-3"><i class="fas fa-shield-alt me-2"></i>Insurance Recommendations</h5>';
    
    data.recommendations.forEach(ins => {
        html += `
            <div class="card mb-3 border-warning">
                <div class="card-body">
                    <h5 class="card-title text-warning"><i class="fas fa-umbrella me-2"></i>${ins.scheme_name}</h5>
                    <p class="text-muted mb-3">${ins.provider}</p>
                    <div class="row g-2 mb-3">
                        <div class="col-md-4">
                            <div class="bg-warning bg-opacity-10 rounded p-3 text-center">
                                <small class="text-muted d-block">Premium to Pay</small>
                                <strong class="text-warning fs-5">₹${ins.premium_amount.toLocaleString()}</strong>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-success bg-opacity-10 rounded p-3 text-center">
                                <small class="text-muted d-block">Sum Insured</small>
                                <strong class="text-success fs-5">₹${ins.sum_insured.toLocaleString()}</strong>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-primary bg-opacity-10 rounded p-3 text-center">
                                <small class="text-muted d-block">Coverage Ratio</small>
                                <strong class="text-primary fs-5">${Math.round(ins.sum_insured / ins.premium_amount)}x</strong>
                            </div>
                        </div>
                    </div>
                    <p class="mb-2"><i class="fas fa-lightbulb text-warning me-1"></i> <strong>Recommendation:</strong> ${ins.recommendation}</p>
                    <details>
                        <summary class="text-primary" style="cursor: pointer;">Coverage Details & Documents</summary>
                        <div class="mt-2">
                            <strong>What's Covered:</strong>
                            <ul class="mb-2">
                                ${ins.coverage.map(c => `<li>${c}</li>`).join('')}
                            </ul>
                            <strong>Documents Needed:</strong>
                            <ul class="mb-0">
                                ${ins.documents.map(d => `<li>${d}</li>`).join('')}
                            </ul>
                        </div>
                    </details>
                </div>
            </div>
        `;
    });
    
    resultsDiv.innerHTML = html;
}

function displaySubsidyResults(data) {
    const resultsDiv = document.getElementById('subsidy-results');
    let html = `
        <div class="alert alert-success mb-4">
            <h5 class="alert-heading"><i class="fas fa-check-circle me-2"></i>Great News!</h5>
            <p class="mb-0">You are eligible for <strong>${data.subsidies.length} government schemes</strong>. Apply now to maximize your benefits!</p>
        </div>
        <h5 class="fw-bold mb-3"><i class="fas fa-gift me-2"></i>Available Subsidies & Benefits</h5>
    `;
    
    data.subsidies.forEach((subsidy, index) => {
        const statusClass = subsidy.eligibility_status.includes('ELIGIBLE') ? 'success' : 'warning';
        html += `
            <div class="card mb-3 border-${statusClass}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title text-${statusClass}"><i class="fas fa-rupee-sign me-2"></i>${subsidy.scheme_name}</h5>
                        <span class="badge bg-${statusClass}">${subsidy.eligibility_status}</span>
                    </div>
                    <div class="bg-${statusClass} bg-opacity-10 rounded p-3 mb-3">
                        <h4 class="mb-0 text-${statusClass}"><i class="fas fa-gift me-2"></i>${subsidy.potential_benefit}</h4>
                    </div>
                    <p class="mb-2">${subsidy.description}</p>
                    <p class="mb-2"><i class="fas fa-clipboard-list text-primary me-1"></i> <strong>How to Apply:</strong> ${subsidy.how_to_apply}</p>
                    <details>
                        <summary class="text-primary" style="cursor: pointer;">Documents Required</summary>
                        <ul class="mt-2 mb-0">
                            ${subsidy.documents.map(d => `<li>${d}</li>`).join('')}
                        </ul>
                    </details>
                </div>
            </div>
        `;
    });
    
    // Total Benefits Summary
    html += `
        <div class="card bg-success text-white mt-4">
            <div class="card-body text-center">
                <h5><i class="fas fa-calculator me-2"></i>Apply for all eligible schemes to maximize your farming income!</h5>
                <p class="mb-0">Visit your nearest Krishi Bhavan or apply online through respective portals.</p>
            </div>
        </div>
    `;
    
    resultsDiv.innerHTML = html;
}
</script>
{% endblock %}
